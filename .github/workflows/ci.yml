name: CI Pipeline - ck-graph-mcp - GHCR Patch Release

on:
  workflow_dispatch:
  repository_dispatch:
    types: [trigger-build-workflow]

permissions:
  contents: write
  packages: write

env:
  GHCR_IMAGE: ghcr.io/ckgitrepouser/prod/ck-graph-mcp/ck-graph-mcp
  DOCKER_REGISTRY: ghcr.io

jobs:
  build-push-verify:
    runs-on: ubuntu-22.04

    # ðŸ”‘ Credentials exposed at JOB level
    env:
      DOCKER_BUILDKIT: 1

    steps:
      # -------------------------------
      # Checkout
      # -------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------
      # Fetch latest GitHub release tag
      # -------------------------------
      - name: Fetch latest GitHub release tag
        id: get-latest-tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          LATEST_TAG=$(gh release list \
            --limit 1 \
            --json tagName \
            --jq '.[0].tagName')

          if [[ -z "$LATEST_TAG" ]]; then
            echo "âŒ No release tag found"
            exit 1
          fi

          if [[ ! "$LATEST_TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Invalid semantic version: $LATEST_TAG"
            exit 1
          fi

          echo "latest_tag=$LATEST_TAG" >> "$GITHUB_OUTPUT"

      # -------------------------------
      # Increment patch version
      # -------------------------------
      - name: Increment patch version
        id: bump-version
        run: |
          set -e

          VERSION="${{ steps.get-latest-tag.outputs.latest_tag }}"
          VERSION="${VERSION#v}"

          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
          PATCH=$((PATCH + 1))

          NEW_TAG="v${MAJOR}.${MINOR}.${PATCH}"

          echo "new_tag=$NEW_TAG" >> "$GITHUB_OUTPUT"
          echo "âœ… New tag: $NEW_TAG"

      # -------------------------------
      # Docker setup (multi-arch)
      # -------------------------------
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ secrets.GPR_USER }}
          password: ${{ secrets.GPR_TOKEN }}

      # -------------------------------
      # Build & push multi-platform image (NO Makefile)
      # -------------------------------
      - name: Build and push multi-platform Docker image
        run: |
          set -e

          TAG="${{ steps.bump-version.outputs.new_tag }}"
          IMAGE="${{ env.GHCR_IMAGE }}"

          echo "ðŸ”¨ Building multi-platform image for linux/amd64 and linux/arm64..."
          echo "Image: ${IMAGE}:${TAG}"

          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            --push \
            --tag "${IMAGE}:${TAG}" \
            --tag "${IMAGE}:latest" \
            .

          echo "âœ… Multi-platform image built and pushed"

      # -------------------------------
      # Verify image exists in GHCR
      # -------------------------------
      - name: Verify image exists in GHCR
        run: |
          set -e

          TAG="${{ steps.bump-version.outputs.new_tag }}"
          IMAGE="${{ env.GHCR_IMAGE }}"

          echo "ðŸ” Verifying image manifest..."
          docker manifest inspect "${IMAGE}:${TAG}" > /dev/null

          echo "âœ… Image exists in GHCR"

      # -------------------------------
      # Create GitHub Release
      # -------------------------------
      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          TAG="${{ steps.bump-version.outputs.new_tag }}"
          PREV_TAG="${{ steps.get-latest-tag.outputs.latest_tag }}"
          IMAGE="${{ env.GHCR_IMAGE }}"

          RELEASE_NOTES=$(cat <<EOF
          ## ðŸš€ Release ${TAG}

          ### Docker Image
          \`\`\`
          docker pull ${IMAGE}:${TAG}
          \`\`\`

          ### Supported Architectures
          - linux/amd64
          - linux/arm64

          ### Changes
          - Automated patch release from ${PREV_TAG} â†’ ${TAG}
          - Docker image built using Docker Buildx
          - Image published to GitHub Container Registry

          ### Image Tags
          - \`${IMAGE}:${TAG}\`
          - \`${IMAGE}:latest\`
          EOF
          )

          gh release create "$TAG" \
            --title "Release $TAG" \
            --notes "$RELEASE_NOTES" \
            --latest

          echo "âœ… GitHub release created: $TAG"

      # -------------------------------
      # Summary
      # -------------------------------
      - name: Summary
        run: |
          {
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… PIPELINE COMPLETED"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "**Previous Tag:** ${{ steps.get-latest-tag.outputs.latest_tag }}"
            echo "**New Tag:** ${{ steps.bump-version.outputs.new_tag }}"
            echo "**Image:** \`${{ env.GHCR_IMAGE }}:${{ steps.bump-version.outputs.new_tag }}\`"
            echo "**Platforms:** linux/amd64, linux/arm64"
          } >> "$GITHUB_STEP_SUMMARY"
