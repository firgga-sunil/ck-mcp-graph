name: CI Pipeline - ck-graph-mcp - GHCR Patch Release

on:
  workflow_dispatch:
  repository_dispatch:
    types: [trigger-build-workflow]

permissions:
  contents: write
  packages: write

env:
  DOCKER_IMAGE_PATH: ghcr.io/ckgitrepouser/prod/ck-graph-mcp/ck-graph-mcp
  DOCKER_REGISTRY: ghcr.io

jobs:
  build-push-verify:
    runs-on: ubuntu-22.04

    # ðŸ”‘ Credentials exposed at JOB level
    env:
      DOCKER_BUILDKIT: 1

    steps:
      # -------------------------------
      # Checkout
      # -------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Bump patch version
        id: version
        uses: firgga-sunil/poc-app-of-apps/.github/actions/fetch-and-increment-version@main
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}   

      - name: Build and push Docker image
        uses: firgga-sunil/poc-app-of-apps/.github/actions/docker-build-push@main
        with:
          image: ${{ env.DOCKER_IMAGE_PATH }}
          new_tag: ${{ steps.version.outputs.new_tag }}
          username: ${{ secrets.GPR_USER }}
          password: ${{ secrets.GPR_TOKEN }}

      - name: Verify image exists in GHCR
        uses: firgga-sunil/poc-app-of-apps/.github/actions/verify-image-upload@main
        with:
          image: ${{ env.DOCKER_IMAGE_PATH }}
          new_tag: ${{ steps.version.outputs.new_tag }}
 
      - name: Create GitHub Release
        uses: firgga-sunil/poc-app-of-apps/.github/actions/create-github-release@main
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          new_tag: ${{ steps.version.outputs.new_tag }}
          latest_tag: ${{ steps.version.outputs.latest_tag }}
          image: ${{ env.DOCKER_IMAGE_PATH }}

      # -------------------------------
      # Summary0
      # -------------------------------
      - name: Summary
        run: |
          {
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… PIPELINE COMPLETED"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "**Previous Tag:** ${{ steps.version.outputs.previous_tag }}"
            echo "**New Tag:** ${{ steps.version.outputs.new_tag }}"
            echo "**Image:** \`${{ env.DOCKER_IMAGE_PATH }}:${{ steps.version.outputs.new_tag }}\`"
            echo "**Platforms:** linux/amd64, linux/arm64"
          } >> "$GITHUB_STEP_SUMMARY"
